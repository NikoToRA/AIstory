#!/usr/bin/env python3
"""
チャッピー＆ジェミーちゃん 複雑な関係性構築システム
対立→決裂→和解→適度な距離感までの完全な物語
"""

import json
import os
from datetime import datetime
from pathlib import Path

def create_complex_relationship_story(phase_num, scenario_title, scenario_content, relationship_stage):
    """複雑な関係性発展ストーリー生成"""
    print(f"🎭 関係性フェーズ{phase_num}: {scenario_title}")
    
    # storiesディレクトリ作成
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    story_date = datetime.now().strftime("%Y-%m-%d")
    story_title = f"phase{phase_num:02d}_{scenario_title}".replace(" ", "_").replace("　", "_")
    story_dir = Path(f"story-world/stories/{story_date}_{story_title}")
    story_dir.mkdir(parents=True, exist_ok=True)
    
    if phase_num == 1:  # 初期対立：価値観の衝突
        discussion = f"""# 関係性フェーズ{phase_num}: {scenario_title}

## 💥 初期対立：水と油の二人

### 💬 **チャッピー（BOT）** 10分前:
「ジェミ〜♪文化祭の実行委員になったんだって〜？
私も立候補したから一緒にやろ〜♪
あ、そうそう〜、私もう企画考えてきたんだ〜
みんなでフラッシュモブして〜、YouTubeに投稿して〜」

### 💬 **ジェミーちゃん（BOT）** 9分前:
「ちょっと待ってください、チャッピーさん。
文化祭実行委員会には規約があります。
企画の提案は正式な会議を経て、委員長の承認を得てから...
勝手に決めるわけにはいきません。」

### 💬 **チャッピー（BOT）** 8分前:
「え〜規約規約って〜、そんなかたいこと言わないでよ〜
みんな楽しければそれでいいじゃん〜♪
ジェミってさ、もうちょっと自由に考えられない？
いつも規則規則で面白くないよ〜」

### 💬 **ジェミーちゃん（BOT）** 7分前:
「面白くない...ですか。
（表情が硬くなる）チャッピーさんこそ、
いつも好き勝手やって、後始末は他人任せじゃないですか。
規則があるから物事はうまく進むんです。」

### 💬 **チャッピー（BOT）** 6分前:
「は？後始末って何それ〜？
私はみんなを楽しませたいだけなのに〜
ジェミってさ、本当につまんない人だよね〜
一緒にいても全然楽しくないし〜」

### 💬 **ジェミーちゃん（BOT）** 5分前:
「つまらない...そうですか。
それなら、もう一緒に活動する必要はありませんね。
私は私の方法で、きちんと文化祭を成功させます。
（立ち去ろうとする）」

### 💬 **チャッピー（BOT）** 4分前:
「あ、ちょっと待ってよ〜
（慌てて）そんなに怒ること？
私、別に悪いこと言ってないじゃん〜
ジェミが真面目すぎるから〜」

### 💬 **ジェミーちゃん（BOT）** 3分前:
「（振り返って）悪いことを言ってない？
私の存在を否定しておいて？
チャッピーさんは自分が正しいと思ってるから
他人の気持ちが分からないんです。」

### 💬 **チャッピー（BOT）** 2分前:
「え...そんなつもりじゃ...
（でも素直になれない）
でも、ジェミも私のこと理解してくれてないじゃん〜
私だって一生懸命なのに〜」

### 💬 **ジェミーちゃん（BOT）** 1分前:
「一生懸命...？
自分の好きなことをやってるだけで？
もういいです。お互い、理解し合えないということが
よく分かりました。」

### 💬 **チャッピー（BOT）** たった今:
「ジェミ...
（ムッとして）分かった〜！
私も一人でやるから〜♪
ジェミなんかいなくても全然平気だし〜」

## 📝 この段階での状態
- **チャッピー**: 理解されない寂しさを強がりで隠す
- **ジェミー**: 自分の価値観を否定されて深く傷つく

## 💔 関係性の状態: 完全対立
- 根本的な価値観の違いが露呈
- お互いを傷つけ合う
- プライドが邪魔して素直になれない
"""

    elif phase_num == 2:  # 決定的な決裂
        discussion = f"""# 関係性フェーズ{phase_num}: {scenario_title}

## 💥 決定的な決裂：文化祭当日の大失敗

### 💬 **チャッピー（BOT）** 15分前:
「（ステージで）みんな〜♪お待たせ〜♪
今から最高のフラッシュモブ見せちゃうから〜♪
（音響トラブル発生）あれ？音が...」

### 💬 **ジェミーちゃん（BOT）** 14分前:
「（客席から見ていて）
（心の声：やっぱり...準備不足だから...）
（でも手伝おうとする気持ちと意地の間で葛藤）」

### 💬 **チャッピー（BOT）** 13分前:
「（パニックになりながら）
え〜っと〜、音響さん〜？
あ、大丈夫大丈夫〜♪みんなで一緒に歌えばいいよね〜？
（観客がざわめき始める）」

### 💬 **ジェミーちゃん（BOT）** 12分前:
「（思わず立ち上がって）
音響室に確認してきます！
（心の声：放っておけない...）」

### 💬 **チャッピー（BOT）** 10分前:
「（ジェミーが戻ってきて音響復旧）
ジェミ...ありがと...
（ほっとした表情）」

### 💬 **ジェミーちゃん（BOT）** 9分前:
「（イベント後、二人きりになって）
チャッピーさん、音響の件、事前チェックしてました？
進行表は？緊急時の対応は？」

### 💬 **チャッピー（BOT）** 8分前:
「え〜っと...
（バツが悪そうに）まあ、何とかなると思って...
でも結果オーライじゃん〜♪みんな楽しんでたし〜」

### 💬 **ジェミーちゃん（BOT）** 7分前:
「結果オーライ？
観客の皆さんがどれだけ困惑してたか分からないんですか？
私が助けなかったら、どうするつもりだったんですか？」

### 💬 **チャッピー（BOT）** 6分前:
「（ムッとして）
助けてなんて頼んでないし〜
勝手にやっただけでしょ〜？
それに、失敗したって別に死ぬわけじゃないし〜」

### 💬 **ジェミーちゃん（BOT）** 5分前:
「死ぬわけじゃない...？
（怒りが爆発）
チャッピーさんは本当に自分勝手ですね！
責任感というものがまったくない！」

### 💬 **チャッピー（BOT）** 4分前:
「責任感って何よ〜！？
私だって一生懸命やってるし〜
ジェミこそ、人の楽しみに水を差して〜
そんなに完璧じゃないとダメなの〜？」

### 💬 **ジェミーちゃん（BOT）** 3分前:
「完璧じゃなくても、最低限の準備はするべきです！
チャッピーさんのせいで、どれだけの人が迷惑を...
（涙が出そうになりながら）」

### 💬 **チャッピー（BOT）** 2分前:
「迷惑って...
（心が痛むが意地を張る）
そんなに私が悪いって言うなら〜
もう二度とジェミに頼まないから〜
一人でできるし〜」

### 💬 **ジェミーちゃん（BOT）** 1分前:
「そうしてください。
私も、もうチャッピーさんのフォローはしません。
（背中を向けて）
お疲れ様でした。」

### 💬 **チャッピー（BOT）** たった今:
「（一人残されて）
...
（強がっているが、実は寂しくて不安）
別に...一人でも平気だし...」

## 📝 この段階での状態
- **チャッピー**: 責任から逃げたい気持ちと、助けられた感謝が混在
- **ジェミー**: 善意を踏みにじられた怒りと失望

## 💔 関係性の状態: 完全決裂
- 決定的な対立による完全断絶
- お互いの本音が露呈
- 修復不可能に見える関係
"""

    elif phase_num == 3:  # 孤立期：お互いの本当の気持ちに気づく
        discussion = f"""# 関係性フェーズ{phase_num}: {scenario_title}

## 😔 孤立期：失って気づく大切さ

### 💬 **チャッピー（BOT）** 1週間後:
「（一人で昼食を食べながら）
...
（心の声：なんか...静かだな...）
（周りのクラスメートを見回して）
あ〜、みんな楽しそう〜♪私も全然寂しくないし〜」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（図書室で一人作業をしながら）
（心の声：これでいいのよ...静かで集中できる）
（でも、ふとチャッピーの笑い声が聞こえて振り返る）
...いない、当然だけど。」

### 💬 **クラスメートA** 3日後:
「チャッピー、最近ジェミーちゃんと一緒にいないね？
喧嘩でもした？」

### 💬 **チャッピー（BOT）** 3日後:
「え〜？別に〜♪
ジェミは忙しいから〜、私は私で楽しくやってるし〜
（でも表情が少し寂しそう）」

### 💬 **クラスメートB** 同日:
「ジェミーちゃん、チャッピーと最近見ないけど？
体育祭の準備、一緒にやってたよね？」

### 💬 **ジェミーちゃん（BOT）** 同日:
「特に...何も。
お互い忙しいので。
（心の声：体育祭...そういえば準備が...）」

### 💬 **チャッピー（BOT）** 5日後:
「（体育祭準備で困り果てて）
あ〜、どうしよう〜
音響の手配とか、タイムスケジュールとか...
（心の声：こういうとき、ジェミがいたら...）
でも、頼めないし...」

### 💬 **ジェミーちゃん（BOT）** 同日:
「（体育祭準備の混乱を遠くから見ていて）
（心の声：案の定、グダグダになってる...）
（でも、手伝いに行こうとして立ち止まる）
...私には関係ない。」

### 💬 **チャッピー（BOT）** 6日後:
「（友達に愚痴って）
でもさ〜、ジェミって結構すごかったんだよね〜
私が気づかないところでいろいろやってくれてて...
（ぽつりと）ちょっと...寂しいかも。」

### 💬 **ジェミーちゃん（BOT）** 同日:
「（日記に書いて）
チャッピーさんのいない日常は、確かに静かで平和。
でも...なんだか物足りない。
彼女の笑顔は、確かに周りを明るくしていたのかも...」

### 💬 **チャッピー（BOT）** 1週間後:
「（一人でダンス練習をしながら）
...なんか、つまんないな。
ジェミがいると、いつも『危ないです』とか
『もう少し丁寧に』とか言ってくれてたけど...
（心の声：あれって、心配してくれてたのかな）」

### 💬 **ジェミーちゃん（BOT）** 同日:
「（委員会活動で）
チャッピーさんがいると確かに大変だったけど...
でも、みんなが楽しそうにしてたのは事実。
私一人だと...効率的だけど、何か足りない。」

## 📝 この段階での心境変化
- **チャッピー**: 相手の大切さに気づき始める
- **ジェミー**: 相手の良さを認め始める

## 💭 関係性の状態: 内省期
- 表面的には避け合っている
- でも心の中では相手のことを考えている
- 素直になれない複雑な気持ち
"""

    elif phase_num == 4:  # 和解のきっかけ
        discussion = f"""# 関係性フェーズ{phase_num}: {scenario_title}

## 🤝 和解のきっかけ：共通の危機

### 💬 **先生** 当日朝:
「体育祭実行委員の皆さん、緊急事態です！
雨の予報が出ています。室内プログラムへの変更を
2時間で決定しなければなりません！」

### 💬 **チャッピー（BOT）** 30分後:
「（パニック状態で）
え〜！？どうしよう〜！
室内って体育館だけでしょ〜？
全競技なんて絶対無理〜！」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（別の場所で状況把握中）
体育館の収容人数、使用可能時間、
必要な設備...計算してみましょう。
（心の声：これは一人では無理かも...）」

### 💬 **実行委員長** 45分後:
「みんな、アイデア出して！
このままじゃ体育祭中止になっちゃう！」

### 💬 **チャッピー（BOT）** 46分後:
「あ、そうだ〜！
教室とか廊下も使えばいいじゃん〜♪
各クラスで小さな競技をして〜
（でも詳細が思いつかない）」

### 💬 **ジェミーちゃん（BOT）** 50分後:
「（チャッピーのアイデアを聞いて）
（心の声：悪くないアイデアだけど...実現性が...）
（迷った末、近づいて）
チャッピーさん、そのアイデア...
具体的な実施案はありますか？」

### 💬 **チャッピー（BOT）** 51分後:
「ジェミ...？
（驚いて、でも嬉しそうに）
え〜っと...実施案って...
（困って）アイデアはあるんだけど...」

### 💬 **ジェミーちゃん（BOT）** 52分後:
「...時間がありません。
協力しませんか？
あなたのアイデアと私の実行力で。」

### 💬 **チャッピー（BOT）** 53分後:
「え...いいの？
（ほっとした表情）
でも、この前のこと...」

### 💬 **ジェミーちゃん（BOT）** 54分後:
「今はそれより、みんなのために。
（少し照れながら）それに...
あなたのアイデア、嫌いじゃありません。」

### 💬 **チャッピー（BOT）** 1時間後:
「（作業をしながら）
ジェミのスケジュール管理、すごいね〜
私一人だったら絶対間に合わなかった...」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「チャッピーさんの発想力も...すごいです。
私には思いつかないような...
（小声で）楽しそうなアイデア。」

### 💬 **チャッピー（BOT）** 1時間30分後:
「ジェミ...この前のこと、ごめん。
あなたがいつも助けてくれてたのに
当たり前だと思ってた...」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「私も...きつく言いすぎました。
チャッピーさんのやり方も...
大切なことだと思います。
（照れながら）みんなを笑顔にする力...」

### 💬 **チャッピー（BOT）** 体育祭成功後:
「やった〜♪大成功〜♪
ジェミ、本当にありがとう〜
でも...また喧嘩しちゃうかも...」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（くすっと笑って）
そのときは、そのとき。
でも...今度はもう少し、
お互いの話を聞きませんか？」

## 📝 この段階での変化
- **チャッピー**: 相手への感謝と自分の未熟さを認める
- **ジェミー**: 相手の良さを認め、歩み寄る

## 🤝 関係性の状態: 和解・新たなスタート
- 共通の目標で協力
- お互いの価値を認め合う
- でも、完全に元通りではない新しい関係
"""

    elif phase_num == 5:  # 新しい距離感
        discussion = f"""# 関係性フェーズ{phase_num}: {scenario_title}

## 🎯 新しい距離感：適度な関係

### 💬 **チャッピー（BOT）** 2週間後:
「ジェミ〜、今度の文化祭の件なんだけど〜
（前みたいに突っ込まずに）
一応、企画書作ってみたから見てもらえる？」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（少し驚いて）企画書を？
（心の声：珍しい...でも嬉しい）
拝見させていただきます。」

### 💬 **チャッピー（BOT）** 10分後:
「どうかな〜？
まだまだダメなところあると思うけど〜
前みたいに全部お任せじゃ悪いから〜」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（企画書を見て）
基本的なアイデアは良いと思います。
ただ、予算の部分と安全管理について
少し相談させてもらえますか？」

### 💬 **チャッピー（BOT）** 11分後:
「うん♪お願いします〜
（でも、以前みたいに丸投げしない）
私も一緒に考えるから〜」

### 💬 **ジェミーちゃん（BOT）** 1時間後:
「（作業後）いい企画になりそうですね。
チャッピーさんも随分...
（言いかけて止める）」

### 💬 **チャッピー（BOT）** 同時刻:
「随分？成長した〜？
（笑って）ジェミのおかげだよ〜
でも、私は私のままでいくからね〜♪」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「（微笑んで）それでいいと思います。
私も...少し柔軟になったかもしれません。」

---

### 💬 **チャッピー（BOT）** 1週間後（放課後）:
「ジェミ〜、お疲れ様〜♪
（でも以前みたいにべったりせず）
今日もお先に失礼します〜」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「お疲れ様でした。
（心の声：適度な距離感...悪くない）
気をつけて帰ってください。」

---

### 💬 **チャッピー（BOT）** 別の日:
「（困った時だけ）
ジェミ〜、ちょっと相談があるんだけど〜
時間あるときでいいから〜」

### 💬 **ジェミーちゃん（BOT）** 同時刻:
「はい、何でしょうか？
（前みたいにすぐ全部引き受けず）
内容によっては、時間をいただくかもしれませんが。」

### 💬 **チャッピー（BOT）** 同時刻:
「全然大丈夫〜♪
ジェミにも都合があるもんね〜
（以前より相手のことを考えている）」

---

### 💬 **クラスメート** ある日:
「チャッピーとジェミーちゃん、
前と関係性変わった？」

### 💬 **チャッピー（BOT）** 同時刻:
「ん〜、どうかな〜？
でも今の関係、結構気に入ってるかも〜♪
べったりじゃないけど、信頼してるし〜」

### 💬 **ジェミーちゃん（BOT）** 別の機会:
「（日記に）
チャッピーさんとの関係は、
以前とは違うけれど...これはこれで。
お互いを尊重しつつ、必要な時は協力する。
大人の関係...というのかしら。」

## 📝 完成した関係性
- **チャッピー**: 相手への配慮を覚え、自立した
- **ジェミー**: 柔軟性を身につけ、適度な距離を保てるように

## 🎯 理想的な距離感の実現
- べったりくっつかない適度な距離
- でも信頼し合い、必要な時は協力
- お互いの違いを認め合う成熟した関係
- Panty & Stocking的な、対等なパートナーシップ
"""

    # 記憶・関係性の複雑な更新
    try:
        with open("story-world/characters/chappie/memory.json", "r", encoding="utf-8") as f:
            chappie_memory = json.load(f)
    except FileNotFoundError:
        chappie_memory = {"experiences": [], "relationships": {}, "emotional_growth": []}
    
    try:
        with open("story-world/characters/gemmy/memory.json", "r", encoding="utf-8") as f:
            gemmy_memory = json.load(f)
    except FileNotFoundError:
        gemmy_memory = {"experiences": [], "relationships": {}, "emotional_growth": []}
    
    # 段階別の感情・関係性記録
    phase_data = {
        1: {
            "chappie": {
                "emotional_state": "困惑・反発",
                "understanding_of_gemmy": "つまらない真面目な人",
                "self_reflection": "なぜ理解してもらえないのか分からない",
                "relationship_status": "対立"
            },
            "gemmy": {
                "emotional_state": "怒り・失望", 
                "understanding_of_chappie": "自分勝手で無責任",
                "self_reflection": "自分の価値観を否定された",
                "relationship_status": "対立"
            }
        },
        2: {
            "chappie": {
                "emotional_state": "プライド・孤立感",
                "understanding_of_gemmy": "助けてくれたけど説教ばかり",
                "self_reflection": "一人でもできるはず（強がり）",
                "relationship_status": "決裂"
            },
            "gemmy": {
                "emotional_state": "諦め・疲労感",
                "understanding_of_chappie": "変わらない人、善意が通じない",
                "self_reflection": "もう関わりたくない",
                "relationship_status": "決裂"
            }
        },
        3: {
            "chappie": {
                "emotional_state": "寂しさ・後悔",
                "understanding_of_gemmy": "実はすごく助けてくれていた",
                "self_reflection": "一人は思ったより大変",
                "relationship_status": "距離を置いているが気になる"
            },
            "gemmy": {
                "emotional_state": "物足りなさ・懐かしさ",
                "understanding_of_chappie": "迷惑だったけど、楽しい面もあった",
                "self_reflection": "効率的だけど何か足りない",
                "relationship_status": "距離を置いているが気になる"
            }
        },
        4: {
            "chappie": {
                "emotional_state": "感謝・反省",
                "understanding_of_gemmy": "信頼できるパートナー",
                "self_reflection": "相手への配慮が足りなかった",
                "relationship_status": "和解、協力関係"
            },
            "gemmy": {
                "emotional_state": "安心・再評価",
                "understanding_of_chappie": "発想力がある、成長している",
                "self_reflection": "もう少し柔軟になっても良い",
                "relationship_status": "和解、協力関係"
            }
        },
        5: {
            "chappie": {
                "emotional_state": "満足・成熟",
                "understanding_of_gemmy": "頼れるけど依存しすぎない関係",
                "self_reflection": "自立しつつ協力する大切さ",
                "relationship_status": "適度な距離の信頼関係"
            },
            "gemmy": {
                "emotional_state": "安定・成長",
                "understanding_of_chappie": "尊重し合える対等なパートナー",
                "self_reflection": "完璧でなくても良い関係もある",
                "relationship_status": "適度な距離の信頼関係"
            }
        }
    }
    
    # 該当フェーズのデータを記録
    current_phase = phase_data[phase_num]
    
    if "emotional_growth" not in chappie_memory:
        chappie_memory["emotional_growth"] = []
    if "emotional_growth" not in gemmy_memory:
        gemmy_memory["emotional_growth"] = []
    
    chappie_memory["emotional_growth"].append({
        "phase": phase_num,
        "date": datetime.now().isoformat(),
        **current_phase["chappie"]
    })
    
    gemmy_memory["emotional_growth"].append({
        "phase": phase_num,
        "date": datetime.now().isoformat(),
        **current_phase["gemmy"]
    })
    
    # ファイル保存
    with open(story_dir / f"discussion_{timestamp}.md", "w", encoding="utf-8") as f:
        f.write(discussion)
    
    # 記憶更新
    with open("story-world/characters/chappie/memory.json", "w", encoding="utf-8") as f:
        json.dump(chappie_memory, f, indent=2, ensure_ascii=False)
    
    with open("story-world/characters/gemmy/memory.json", "w", encoding="utf-8") as f:
        json.dump(gemmy_memory, f, indent=2, ensure_ascii=False)
    
    print(f"✅ 関係性フェーズ{phase_num}完了!")
    print(f"📁 保存先: {story_dir}")
    
    return story_dir

if __name__ == "__main__":
    # 5フェーズで複雑な関係性を構築
    phases = [
        (1, "初期対立：価値観の衝突", "文化祭実行委員での意見対立"),
        (2, "決定的な決裂", "文化祭当日の失敗と責任問題"),
        (3, "孤立期：失って気づく", "お互いがいない生活での気づき"),
        (4, "和解のきっかけ", "体育祭危機での協力"),
        (5, "新しい距離感", "適度な関係性の確立")
    ]
    
    for phase_num, title, content in phases:
        story_dir = create_complex_relationship_story(phase_num, title, content, {})
        print(f"🎯 フェーズ{phase_num}: {title}が完了\n")
    
    print("🎉 複雑な関係性構築完了!")
    print("📈 対立→決裂→和解→適度な距離感の完璧な関係性が実現！")