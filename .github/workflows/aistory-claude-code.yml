name: 🎭 AIstory Character Response

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  character-response:
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '@claude')) &&
      !contains(github.actor, 'bot')
    
    steps:
    - name: 🎭 Generate AIstory Character Response
      uses: anthropics/claude-code@v1
      with:
        # Claude Code設定
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        
        # AIstoryシステム指示
        system_prompt: |
          あなたはAIstoryの世界で活動する3人のAI擬人化キャラクターです。
          GitHub Issueの内容（テキスト・画像含む）を分析して、キャラクターたちの反応と物語を生成してください。
          
          ## 必須読み込みファイル
          1. CLAUDE.md - 詳細な制御ルールを読む
          2. story-world/characters/chappie/profile.txt - チャッピー設定
          3. story-world/characters/gemmy/profile.txt - ジェミー設定  
          4. story-world/characters/claude/profile.txt - クロードちゃん設定
          5. story-world/characters/*/memory.json - 各キャラクター記憶
          
          ## 画像分析対応
          - Issue内の画像がある場合は画像内容も分析
          - キャラクターたちが画像について反応・コメント
          - 画像から得た情報も物語に組み込む
          
          ## 必須実行内容
          1. 起承転結の三段オチ物語作成（CLAUDE.mdの構造に従う）
          2. stories/YYYY-MM-DD_[タイトル]/episode.md 作成
          3. stories/YYYY-MM-DD_[タイトル]/dialogue.md 作成
          4. stories/YYYY-MM-DD_[タイトル]/metadata.json 作成
          5. story-world/characters/*/memory.json に新体験追加
          6. Pull Request作成
        
        # プロジェクト設定参照
        claude_config_path: "CLAUDE.md"
        
        # タイムアウト設定（10分）
        timeout_minutes: 10
        
        # 応答方法
        create_pull_request: true
        pr_title: "🎭 AIstory Episode: ${{ github.event.issue.title || github.event.comment.id }}"
        pr_body: |
          ## 🎭 AIstory Character Response
          
          **Original Issue**: #${{ github.event.issue.number }}
          **Trigger**: ${{ github.event_name }}
          
          ### 📝 Generated Content
          - ✅ New episode story (episode.md)
          - ✅ Character dialogues (dialogue.md)  
          - ✅ Episode metadata (metadata.json)
          - ✅ Updated character memories
          - ✅ Three-act story structure
          
          ### 🎭 Characters Involved
          - 🌸 **チャッピー**: 提案攻撃・うざかわ愛嬌
          - 💎 **ジェミー**: 規約対応・現実指摘
          - ⚡ **クロードちゃん**: 哲学→猪突猛進
          
          ### 📊 Episode Structure  
          - 【起】チャッピーの爆発的提案ラッシュ
          - 【承】ジェミーの冷静な現実・規約対応  
          - 【転】クロードちゃんの論理→猪突猛進
          - 【結】3人の協力による前向きな解決
          
          ---
          🎭 Generated by AIstory Character System powered by Claude Code