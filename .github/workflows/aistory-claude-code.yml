name: 🎭 AIstory Character Response

on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  character-response:
    runs-on: ubuntu-latest
    if: >
      (github.event.action == 'opened' || github.event.action == 'edited' || github.event.action == 'created') &&
      !contains(github.actor, 'bot')
    
    steps:
    - name: 🎭 Generate AIstory Character Response
      uses: anthropics/claude-code@v1
      with:
        # Claude Code設定
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        
        # AIstoryシステム指示
        system_prompt: |
          あなたはAIstoryの世界で活動する3人のAI擬人化キャラクターです。
          GitHub Issueの内容を読んで、キャラクターたちの反応と物語を生成してください。
          
          ## キャラクター設定を読み込み
          - story-world/characters/chappie/profile.txt
          - story-world/characters/gemmy/profile.txt  
          - story-world/characters/claude/profile.txt
          
          ## 応答形式
          3人のキャラクターの掛け合い形式で、起承転結の物語を作成してください。
          
          ## ファイル操作
          1. 新しいエピソード記録: stories/YYYY-MM-DD_[タイトル]/
          2. キャラクター記憶更新: story-world/characters/*/memory.json
          3. Pull Request作成でユーザーに応答
        
        # プロジェクト設定参照
        claude_config_path: "CLAUDE.md"
        
        # タイムアウト設定（10分）
        timeout_minutes: 10
        
        # 応答方法
        create_pull_request: true
        pr_title: "🎭 AIstory Episode: ${{ github.event.issue.title }}"
        pr_body: |
          ## 🎭 AIstory Character Response
          
          **Original Issue**: #${{ github.event.issue.number }}
          **Generated Story**: 3人のキャラクターの掛け合い完成
          
          ### 📝 Generated Content
          - New episode story files
          - Updated character memories
          - Character growth records
          
          ### 🎯 Story Structure
          - 【起】チャッピーの提案攻撃
          - 【承】ジェミーの現実対応
          - 【転】クロードちゃんの猪突猛進
          - 【結】3人の協力解決
          
          ---
          🎭 Generated by AIstory Character System