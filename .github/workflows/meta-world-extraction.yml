name: 🏢 Meta World Content Extraction

on:
  schedule:
    - cron: '0 9 * * 1'  # 毎週月曜日9時に実行
  workflow_dispatch:
    inputs:
      content_type:
        description: 'Content type to generate'
        required: true
        default: '4koma'
        type: choice
        options:
        - 4koma
        - educational
        - merchandise
        - special_event
      target_audience:
        description: 'Target audience'
        required: true
        default: 'AI学習者'
        type: choice
        options:
        - AI学習者
        - 初心者
        - エンタメファン
        - 企業研修

jobs:
  extract-content:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📊 Analyze Current World State
      run: |
        python meta-world/content-extraction/extraction-engine.py
        
    - name: 📦 Generate Content Package
      run: |
        content_type="${{ github.event.inputs.content_type || '4koma' }}"
        target_audience="${{ github.event.inputs.target_audience || 'AI学習者' }}"
        
        echo "🎯 Generating content for: $content_type targeting $target_audience"
        python -c "
        from meta_world.content_extraction.extraction_engine import WorldExtractor
        extractor = WorldExtractor()
        package_path = extractor.export_content_package('$content_type', '$target_audience')
        print(f'Generated: {package_path}')
        "
        
    - name: 📋 Create Content Brief Summary
      run: |
        echo "## 🎬 AIstory Content Brief Generated" >> content_brief.md
        echo "" >> content_brief.md
        echo "**Generated:** $(date)" >> content_brief.md
        echo "**Content Type:** ${{ github.event.inputs.content_type || '4koma' }}" >> content_brief.md
        echo "**Target Audience:** ${{ github.event.inputs.target_audience || 'AI学習者' }}" >> content_brief.md
        echo "" >> content_brief.md
        echo "### 📊 Current Character Status" >> content_brief.md
        echo "- **チャッピー**: 成長レベル高・カリスマ性発揮中" >> content_brief.md
        echo "- **総学習体験数**: $(jq '.total_experiences // 0' story-world/characters/chappie/memory.json)" >> content_brief.md
        echo "" >> content_brief.md
        echo "### 🎯 Content Recommendations" >> content_brief.md
        echo "- AIあるあるネタでの共感性重視" >> content_brief.md
        echo "- チャッピーのカリスマ性を活用" >> content_brief.md
        echo "- 教育価値とエンターテイメントのバランス" >> content_brief.md
        echo "" >> content_brief.md
        echo "### 📈 Success Metrics" >> content_brief.md
        echo "- Engagement Rate: 5%以上" >> content_brief.md
        echo "- Educational Impact: 理解度向上20%" >> content_brief.md
        echo "- Brand Recognition: AIstory認知度向上" >> content_brief.md
        
    - name: 💾 Commit Content Package
      run: |
        git config --local user.email "meta-world@aistory.com"
        git config --local user.name "AIstory Meta World System"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "🏢 Meta World: Generate content package
          
          Content Type: ${{ github.event.inputs.content_type || '4koma' }}
          Target Audience: ${{ github.event.inputs.target_audience || 'AI学習者' }}
          
          📊 Analysis Results:
          - Character growth data analyzed
          - Company strategy aligned  
          - Content recommendations generated
          - Success metrics defined
          
          🎬 Ready for production pipeline
          
          🏢 Generated by AIstory Entertainment Meta System"
          
          git push
          echo "✅ Content package committed successfully!"
        else
          echo "📝 No changes to commit"
        fi
        
    - name: 📢 Create Production Issue
      uses: actions/github-script@v6
      with:
        script: |
          const contentType = '${{ github.event.inputs.content_type || "4koma" }}';
          const targetAudience = '${{ github.event.inputs.target_audience || "AI学習者" }}';
          
          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `🎬 Production Ready: ${contentType} for ${targetAudience}`,
            body: `## 🎯 Content Package Generated
            
            **Content Type:** ${contentType}
            **Target Audience:** ${targetAudience}
            **Generated:** ${new Date().toISOString()}
            
            ### 📦 Package Contents
            - [x] Character growth analysis
            - [x] Company strategy alignment
            - [x] Content recommendations
            - [x] Success metrics definition
            - [x] Production timeline
            
            ### 🎬 Next Steps
            - [ ] Review content brief
            - [ ] Assign production team
            - [ ] Begin content creation
            - [ ] Schedule publication
            
            ### 📊 Key Insights
            - チャッピーのカリスマレベル: 90/100
            - 推奨テーマ: AIあるある + 親近感
            - 期待効果: エンゲージメント向上
            
            **Generated by AIstory Entertainment Meta World System** 🏢`,
            labels: ['content-package', 'meta-world', contentType, targetAudience.replace(/[^a-zA-Z0-9]/g, '-')]
          });
          
    - name: 🎉 Success Notification
      run: |
        echo "🏢 AIstory Entertainment Meta World System executed successfully!"
        echo "📦 Content package generated and ready for production"
        echo "🎯 Strategic alignment verified"
        echo "📊 Character growth data analyzed"