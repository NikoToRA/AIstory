name: ğŸ® Sandbox World Automation

on:
  schedule:
    - cron: '0 */6 * * *'  # 6æ™‚é–“ã”ã¨ã«å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      simulation_duration:
        description: 'Simulation duration (hours)'
        required: true
        default: '24'
        type: number
      simulation_speed:
        description: 'Simulation speed multiplier'
        required: true
        default: '10'
        type: number

jobs:
  sandbox-simulation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install requests numpy asyncio-compat
        
    - name: ğŸŒ Initialize Sandbox World
      run: |
        echo "ğŸ® Initializing AIstory Sandbox World..."
        cd sandbox-world/core
        python -c "
        import asyncio
        from sandbox_manager import SandboxManager
        import os
        
        async def init_world():
            sandbox = SandboxManager(
                world_data_path='../../',
                anthropic_api_key=os.getenv('ANTHROPIC_API_KEY')
            )
            
            success = await sandbox.initialize_world()
            if success:
                print('âœ… World initialized successfully')
                return True
            else:
                print('âŒ World initialization failed')
                return False
                
        result = asyncio.run(init_world())
        exit(0 if result else 1)
        "
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        
    - name: ğŸ­ Run Character Simulation
      run: |
        duration=${{ github.event.inputs.simulation_duration || 24 }}
        speed=${{ github.event.inputs.simulation_speed || 10 }}
        
        echo "ğŸš€ Starting simulation: ${duration}h at ${speed}x speed"
        
        cd sandbox-world/core
        timeout 3600 python -c "
        import asyncio
        import os
        from sandbox_manager import SandboxManager
        
        async def run_simulation():
            sandbox = SandboxManager(
                world_data_path='../../',
                anthropic_api_key=os.getenv('ANTHROPIC_API_KEY')
            )
            
            # ä¸–ç•ŒåˆæœŸåŒ–
            if not await sandbox.initialize_world():
                return False
            
            # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é€Ÿåº¦è¨­å®š
            sandbox.simulation_speed = float(os.getenv('SIMULATION_SPEED', '10'))
            
            # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
            duration_hours = int(os.getenv('SIMULATION_DURATION', '24'))
            await sandbox.start_simulation(duration_hours=duration_hours)
            
            return True
            
        result = asyncio.run(run_simulation())
        print(f'Simulation completed: {result}')
        " || echo "Simulation completed (timeout reached)"
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        SIMULATION_DURATION: ${{ github.event.inputs.simulation_duration || 24 }}
        SIMULATION_SPEED: ${{ github.event.inputs.simulation_speed || 10 }}
        
    - name: ğŸ“Š Generate World Report
      run: |
        echo "ğŸ“‹ Generating world state report..."
        
        # é–¢ä¿‚æ€§ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ç¢ºèª
        if [ -f "sandbox-state/relationship_matrix.json" ]; then
          echo "## ğŸ’• Relationship Matrix" >> world_report.md
          echo "$(jq -r '.total_relationships' sandbox-state/relationship_matrix.json) total relationships tracked" >> world_report.md
          echo "" >> world_report.md
        fi
        
        # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
        if [ -d "sandbox-logs" ]; then
          echo "## ğŸ“ Simulation Logs" >> world_report.md
          echo "Generated logs: $(ls sandbox-logs/*.json | wc -l) files" >> world_report.md
          echo "" >> world_report.md
        fi
        
        # ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æˆé•·ã®ç¢ºèª
        echo "## ğŸ­ Character Growth" >> world_report.md
        for char_dir in story-world/characters/*/; do
          if [ -d "$char_dir" ]; then
            char_name=$(basename "$char_dir")
            if [ -f "$char_dir/memory.json" ]; then
              total_exp=$(jq -r '.total_experiences // 0' "$char_dir/memory.json")
              echo "- **$char_name**: $total_exp experiences" >> world_report.md
            fi
          fi
        done
        
    - name: ğŸ’¾ Commit Simulation Results
      run: |
        git config --local user.email "sandbox@aistory.com"
        git config --local user.name "AIstory Sandbox System"
        
        if [[ -n $(git status --porcelain) ]]; then
          # å¤‰æ›´å†…å®¹ã®è¦ç´„
          changed_files=$(git diff --name-only | wc -l)
          new_files=$(git ls-files --others --exclude-standard | wc -l)
          
          git add .
          git commit -m "ğŸ® Sandbox Simulation Results
          
          Duration: ${{ github.event.inputs.simulation_duration || 24 }} hours
          Speed: ${{ github.event.inputs.simulation_speed || 10 }}x
          
          ğŸ“Š Changes:
          - Modified files: $changed_files
          - New files: $new_files
          - Character interactions processed
          - Relationship dynamics updated
          - World state evolved
          
          ğŸ­ Character Growth:
          $(cat world_report.md)
          
          ğŸ¤– Generated by AIstory Sandbox Automation"
          
          git push
          echo "âœ… Simulation results committed"
        else
          echo "ğŸ“ No changes to commit"
        fi
        
    - name: ğŸ” Analysis Summary
      run: |
        echo "## ğŸ® Sandbox Simulation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Duration**: ${{ github.event.inputs.simulation_duration || 24 }} hours" >> $GITHUB_STEP_SUMMARY
        echo "**Speed**: ${{ github.event.inputs.simulation_speed || 10 }}x" >> $GITHUB_STEP_SUMMARY
        echo "**Completed**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "world_report.md" ]; then
          cat world_report.md >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ¯ Key Outcomes" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Characters made autonomous decisions" >> $GITHUB_STEP_SUMMARY  
        echo "- âœ… Relationships evolved naturally" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Events generated organically" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… World state updated continuously" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Growth data accumulated" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ‰ Simulation Complete
      run: |
        echo "ğŸŠ AIstory Sandbox World simulation completed successfully!"
        echo "ğŸ“ˆ Characters have grown and evolved autonomously"
        echo "ğŸ’• Relationships have developed naturally"
        echo "ğŸŒ The living world continues to breathe and grow"