name: ğŸ¤– Chappie Auto Learning System

on:
  push:
    paths:
      - 'auto-learning/new-images/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  auto-learn:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        pip install requests pillow python-dotenv openai anthropic
        
    - name: ğŸ” Check for New Images
      id: check_images
      run: |
        if find auto-learning/new-images -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | grep -q .; then
          echo "has_images=true" >> $GITHUB_OUTPUT
          echo "ğŸ“¸ New images found!"
        else
          echo "has_images=false" >> $GITHUB_OUTPUT
          echo "ğŸ“­ No new images found"
        fi
        
    - name: ğŸ§  Process Images & Update Character
      if: steps.check_images.outputs.has_images == 'true'
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python auto-learning/scripts/auto_learn.py
        
    - name: ğŸ“ Move Processed Images
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p "auto-learning/processed/$timestamp"
        mv auto-learning/new-images/* "auto-learning/processed/$timestamp/" || true
        
    - name: ğŸ’¾ Commit Changes
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Chappie Auto Learning Bot"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "ğŸ¤– Auto-update: Chappie character learned from new images
          
          - Processed new 4-koma manga images
          - Updated character profile and memory
          - Enhanced dialogue patterns and personality traits
          
          ğŸ­ Generated with Chappie Auto Learning System"
          
          git push
          echo "âœ… Character profile updated successfully!"
        else
          echo "ğŸ“ No changes to commit"
        fi
        
    - name: ğŸ‰ Success Notification
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        echo "ğŸŠ Chappie has successfully learned from new images!"
        echo "ğŸ“ˆ Character profile has been automatically updated"
        echo "ğŸ” Check the latest commit for details"