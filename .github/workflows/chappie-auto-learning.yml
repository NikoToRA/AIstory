name: 🤖 Chappie Auto Learning System

on:
  push:
    paths:
      - 'auto-learning/new-images/**'
  workflow_dispatch: # 手動実行も可能

jobs:
  auto-learn:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: 📦 Install Dependencies
      run: |
        pip install requests pillow python-dotenv openai anthropic
        
    - name: 🔍 Check for New Images
      id: check_images
      run: |
        if find auto-learning/new-images -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" | grep -q .; then
          echo "has_images=true" >> $GITHUB_OUTPUT
          echo "📸 New images found!"
        else
          echo "has_images=false" >> $GITHUB_OUTPUT
          echo "📭 No new images found"
        fi
        
    - name: 🧠 Process Images & Update Character
      if: steps.check_images.outputs.has_images == 'true'
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python auto-learning/scripts/auto_learn.py
        
    - name: 📁 Move Processed Images
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        timestamp=$(date +%Y%m%d_%H%M%S)
        mkdir -p "auto-learning/processed/$timestamp"
        mv auto-learning/new-images/* "auto-learning/processed/$timestamp/" || true
        
    - name: 💾 Commit Changes
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "Chappie Auto Learning Bot"
        
        if [[ -n $(git status --porcelain) ]]; then
          git add .
          git commit -m "🤖 Auto-update: Chappie character learned from new images
          
          - Processed new 4-koma manga images
          - Updated character profile and memory
          - Enhanced dialogue patterns and personality traits
          
          🎭 Generated with Chappie Auto Learning System"
          
          git push
          echo "✅ Character profile updated successfully!"
        else
          echo "📝 No changes to commit"
        fi
        
    - name: 🎉 Success Notification
      if: steps.check_images.outputs.has_images == 'true'
      run: |
        echo "🎊 Chappie has successfully learned from new images!"
        echo "📈 Character profile has been automatically updated"
        echo "🔍 Check the latest commit for details"